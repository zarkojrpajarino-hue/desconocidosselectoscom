# CI/CD Pipeline para Lovable Project
# Este archivo debe estar en tu repositorio de GitHub
# Se ejecuta automรกticamente en cada push/PR

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JOB 1: Type Check & Lint
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  typecheck:
    name: ๐ TypeScript Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
      
      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ๐ Install dependencies
        run: npm ci
      
      - name: ๐ TypeScript type check
        run: npx tsc --noEmit
      
      - name: ๐งน ESLint check
        run: npm run lint || true  # No falla si lint no estรก configurado

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JOB 2: Build Test
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  build:
    name: ๐๏ธ Build Test
    runs-on: ubuntu-latest
    needs: typecheck
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
      
      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ๐ Install dependencies
        run: npm ci
      
      - name: ๐๏ธ Build application
        run: npm run build
        env:
          # Variables de entorno para build
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
      
      - name: ๐ Report build size
        run: |
          echo "## Build Output Size" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          du -sh dist/* | while read size file; do
            echo "- $file: $size" >> $GITHUB_STEP_SUMMARY
          done

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JOB 3: Security Audit
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  security:
    name: ๐ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
      
      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ๐ Install dependencies
        run: npm ci
      
      - name: ๐ Run npm audit
        run: npm audit --audit-level=high || true
        continue-on-error: true
      
      - name: ๐ Check for secrets in code
        run: |
          # Buscar posibles secrets hardcodeados
          if grep -rE "(sk_live_|pk_live_|password\s*=\s*['\"][^'\"]+['\"])" --include="*.ts" --include="*.tsx" --include="*.js" src/; then
            echo "โ๏ธ Possible hardcoded secrets found!"
            exit 1
          fi
          echo "โ No hardcoded secrets detected"

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JOB 4: Edge Functions Validation
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  edge-functions:
    name: โก Edge Functions Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
      
      - name: ๐ Validate Edge Functions syntax
        run: |
          echo "## Edge Functions Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for dir in supabase/functions/*/; do
            if [ -f "${dir}index.ts" ]; then
              func_name=$(basename "$dir")
              echo "- โ $func_name" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Contar funciones
          count=$(ls -d supabase/functions/*/ 2>/dev/null | wc -l)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: $count Edge Functions**" >> $GITHUB_STEP_SUMMARY

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JOB 5: Deploy Notification (solo en main)
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  notify:
    name: ๐ข Deploy Status
    runs-on: ubuntu-latest
    needs: [typecheck, build, security, edge-functions]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ๐ข Success notification
        run: |
          echo "## ๐ Deploy Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- โ TypeScript: No errors" >> $GITHUB_STEP_SUMMARY
          echo "- โ Build: Successful" >> $GITHUB_STEP_SUMMARY
          echo "- โ Security: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- โ Edge Functions: Valid" >> $GITHUB_STEP_SUMMARY

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CONFIGURACIรN NECESARIA EN GITHUB:
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 
# 1. Ve a tu repo en GitHub
# 2. Settings โ Secrets and variables โ Actions
# 3. Agrega estos secrets:
#    - VITE_SUPABASE_URL (opcional para build)
#    - VITE_SUPABASE_PUBLISHABLE_KEY (opcional para build)
#
# El pipeline se ejecutarรก automรกticamente en cada push.
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
